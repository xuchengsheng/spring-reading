## Beançš„é”€æ¯è¿‡ç¨‹

- [Beançš„é”€æ¯è¿‡ç¨‹](#beançš„é”€æ¯è¿‡ç¨‹)
  - [ä¸€ã€åŸºæœ¬ä¿¡æ¯](#ä¸€åŸºæœ¬ä¿¡æ¯)
  - [äºŒã€çŸ¥è¯†å‚¨å¤‡](#äºŒçŸ¥è¯†å‚¨å¤‡)
  - [ä¸‰ã€åŸºæœ¬æè¿°](#ä¸‰åŸºæœ¬æè¿°)
  - [å››ã€ä¸»è¦åŠŸèƒ½](#å››ä¸»è¦åŠŸèƒ½)
  - [äº”ã€æœ€ä½³å®è·µ](#äº”æœ€ä½³å®è·µ)
  - [å…­ã€æ—¶åºå›¾](#å…­æ—¶åºå›¾)
  - [ä¸ƒã€æºç åˆ†æ](#ä¸ƒæºç åˆ†æ)
    - [æ³¨å†Œé€‚é…å™¨](#æ³¨å†Œé€‚é…å™¨)
    - [Beané”€æ¯](#beané”€æ¯)
  - [å…«ã€æ³¨æ„äº‹é¡¹](#å…«æ³¨æ„äº‹é¡¹)
  - [ä¹ã€æ€»ç»“](#ä¹æ€»ç»“)
    - [æœ€ä½³å®è·µæ€»ç»“](#æœ€ä½³å®è·µæ€»ç»“)
    - [æºç åˆ†ææ€»ç»“](#æºç åˆ†ææ€»ç»“)


### ä¸€ã€åŸºæœ¬ä¿¡æ¯

âœ’ï¸ **ä½œè€…** - Lex ğŸ“ **åšå®¢** - [æ˜é‡‘](https://juejin.cn/user/4251135018533068/posts) ğŸ“š **æºç åœ°å€** - [github](https://github.com/xuchengsheng/spring-reading)

### äºŒã€çŸ¥è¯†å‚¨å¤‡

1. [**Beançš„å®šä¹‰æ³¨å†Œè¿‡ç¨‹**](https://github.com/xuchengsheng/spring-reading/tree/master/spring-core/spring-core-registerBeanDefinition)

   + Beançš„æ³¨å†ŒåŒ…æ‹¬åŠ è½½å’Œè§£æé…ç½®æ–‡ä»¶ï¼Œä»ä¸­æå–Beanå®šä¹‰ã€‚è§£æåçš„Beanä¿¡æ¯ï¼Œå¦‚ç±»åã€ä½œç”¨åŸŸã€å±æ€§ç­‰ï¼Œè¢«æ³¨å†Œåˆ°Springå®¹å™¨ã€‚é€šè¿‡è§£æé…ç½®æ–‡ä»¶ï¼Œå®¹å™¨è·å¾—Beançš„å…ƒæ•°æ®ï¼Œè¿›è€Œåˆ›å»ºBeanå®šä¹‰ï¼ŒåŒ…æ‹¬ç±»åã€ä½œç”¨åŸŸï¼ˆå¦‚singletonæˆ–prototypeï¼‰ã€å±æ€§å€¼ç­‰ã€‚è¿™äº›å®šä¹‰é€šè¿‡å”¯ä¸€æ ‡è¯†ç¬¦ä¸å®¹å™¨å…³è”ï¼Œä»¥ä¾¿åç»­é€šè¿‡ApplicationContextè·å–å’Œç®¡ç†ã€‚

2. [**Beançš„åˆå§‹åŒ–è¿‡ç¨‹**](https://github.com/xuchengsheng/spring-reading/blob/master/spring-core/spring-core-getBean/README.md)

   + é€šè¿‡æ„é€ å‡½æ•°å®ä¾‹åŒ–Beanï¼Œéšåè¿›è¡Œå±æ€§æ³¨å…¥æ»¡è¶³ä¾èµ–å…³ç³»ã€‚è‹¥Beanå®ç°äº†Awareæ¥å£ï¼Œå®¹å™¨é€šè¿‡ç›¸åº”å›è°ƒæ–¹æ³•æ³¨å…¥ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚æ³¨å†Œçš„åç½®å¤„ç†å™¨åœ¨åˆå§‹åŒ–å‰åå¯¹Beanè¿›è¡Œé¢å¤–å¤„ç†ã€‚Beanå®ç°InitializingBeanæ¥å£æ—¶ï¼Œå®¹å™¨è°ƒç”¨afterPropertiesSetæ‰§è¡Œåˆå§‹åŒ–é€»è¾‘ã€‚é€šè¿‡é…ç½®ä¸­çš„init-methodå±æ€§ä¹Ÿå¯æŒ‡å®šè‡ªå®šä¹‰åˆå§‹åŒ–æ–¹æ³•ã€‚æœ€ç»ˆï¼ŒBeanæ ‡è®°ä¸ºå·²åˆå§‹åŒ–çŠ¶æ€ï¼Œå¯è¢«åº”ç”¨ç¨‹åºä½¿ç”¨ã€‚

3. [**Beançš„ä¾èµ–è§£æè¿‡ç¨‹**](https://github.com/xuchengsheng/spring-reading/blob/master/spring-core/spring-core-resolveDependency/README.md)

   + é€šè¿‡å£°æ˜ä¾èµ–ï¼ŒBeanè¡¨è¾¾å¯¹å…¶ä»–Beançš„éœ€æ±‚ã€‚å®¹å™¨é€šè¿‡æŸ¥æ‰¾ä¾èµ–ï¼Œå³åœ¨ApplicationContextä¸­å¯»æ‰¾æ‰€éœ€çš„Beanå®šä¹‰ã€‚ç„¶åï¼Œå®¹å™¨è¿›è¡Œä¾èµ–æ³¨å…¥ï¼Œå°†æ‰¾åˆ°çš„Beanå®ä¾‹æ³¨å…¥åˆ°ç›¸åº”çš„å±æ€§æˆ–æ„é€ å‡½æ•°å‚æ•°ä¸­ã€‚åœ¨å¤„ç†å¾ªç¯ä¾èµ–æ—¶ï¼ŒSpringé€šè¿‡ä½¿ç”¨æå‰æš´éœ²çš„ä»£ç†å¯¹è±¡æ¥è§£å†³å¾ªç¯å¼•ç”¨é—®é¢˜ã€‚æœ€åï¼Œå®¹å™¨æ”¯æŒå»¶è¿Ÿä¾èµ–è§£æï¼Œå³åœ¨éœ€è¦ä½¿ç”¨Beanæ—¶å†è¿›è¡Œå®é™…çš„ä¾èµ–è§£æå’Œæ³¨å…¥ï¼Œä»¥æé«˜æ€§èƒ½å’Œå‡å°‘å¯åŠ¨æ—¶é—´ã€‚

### ä¸‰ã€åŸºæœ¬æè¿°

å®¹å™¨è°ƒç”¨å®ç°äº†`DisposableBean`æ¥å£çš„Beançš„`destroy`æ–¹æ³•æ‰§è¡Œè‡ªå®šä¹‰é”€æ¯é€»è¾‘ã€‚å…¶æ¬¡ï¼Œå¦‚æœBeané…ç½®ä¸­é€šè¿‡`destroy-method`å±æ€§æŒ‡å®šäº†è‡ªå®šä¹‰çš„é”€æ¯æ–¹æ³•ï¼Œå®¹å™¨ä¹Ÿä¼šè°ƒç”¨ã€‚æ¥ç€ï¼Œå¯¹äºå®ç°äº†`DestructionAwareBeanPostProcessor`æ¥å£çš„åç½®å¤„ç†å™¨ï¼Œå®¹å™¨åˆ†åˆ«è°ƒç”¨å…¶`postProcessBeforeDestruction`å’Œ`postProcessAfterDestruction`æ–¹æ³•ï¼Œå…è®¸è¿›è¡Œé¢å¤–çš„æ¸…ç†å·¥ä½œã€‚é€šè¿‡`@PreDestroy`æ³¨è§£ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨Beanæ–¹æ³•ä¸Šæ ‡è®°é”€æ¯å‰çš„æ¸…ç†æ“ä½œã€‚

### å››ã€ä¸»è¦åŠŸèƒ½

1. **æ‰§è¡Œè‡ªå®šä¹‰é”€æ¯é€»è¾‘**

   - è°ƒç”¨å®ç°äº†`DisposableBean`æ¥å£çš„Beançš„`destroy`æ–¹æ³•ï¼Œæ‰§è¡Œæˆ‘ä»¬å®šä¹‰çš„è‡ªå®šä¹‰é”€æ¯é€»è¾‘ï¼Œç”¨äºé‡Šæ”¾èµ„æºæˆ–æ‰§è¡Œå¿…è¦çš„æ¸…ç†å·¥ä½œã€‚

2. **è°ƒç”¨è‡ªå®šä¹‰é”€æ¯æ–¹æ³•**

   - å¦‚æœBeané…ç½®ä¸­é€šè¿‡`destroy-method`å±æ€§æŒ‡å®šäº†è‡ªå®šä¹‰çš„é”€æ¯æ–¹æ³•ï¼Œå®¹å™¨ä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œå…è®¸æˆ‘ä»¬åœ¨é”€æ¯æ—¶æ‰§è¡Œç‰¹å®šçš„æ¸…ç†æ“ä½œã€‚

3. **åç½®å¤„ç†å™¨æ¸…ç†å·¥ä½œ**

   - å¯¹äºå®ç°äº†`DestructionAwareBeanPostProcessor`æ¥å£çš„åç½®å¤„ç†å™¨ï¼Œå®¹å™¨åœ¨é”€æ¯å‰ååˆ†åˆ«è°ƒç”¨å…¶`postProcessBeforeDestruction`å’Œ`postProcessAfterDestruction`æ–¹æ³•ï¼Œå…è®¸è¿›è¡Œé¢å¤–çš„æ¸…ç†å·¥ä½œã€‚

4. **æ‰§è¡Œ`@PreDestroy`æ³¨è§£æ–¹æ³•**

   - é€šè¿‡`@PreDestroy`æ³¨è§£ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨Beançš„æ–¹æ³•ä¸Šæ ‡è®°é”€æ¯å‰çš„æ¸…ç†æ“ä½œï¼Œç¡®ä¿åœ¨é”€æ¯æ—¶æ‰§è¡Œç‰¹å®šçš„ä¸šåŠ¡é€»è¾‘ã€‚

5. **è§¦å‘é”€æ¯é€šçŸ¥**

   - Springå®¹å™¨ä¼šè§¦å‘é”€æ¯é€šçŸ¥ï¼Œé€šçŸ¥ç›¸å…³çš„ç›‘å¬å™¨æˆ–è§‚å¯Ÿè€…ï¼Œå…è®¸åº”ç”¨ç¨‹åºåœ¨Beané”€æ¯æ—¶æ‰§è¡Œç‰¹å®šçš„å¤„ç†ã€‚

### äº”ã€æœ€ä½³å®è·µ

ä½¿ç”¨ Spring çš„åŸºäºæ³¨è§£çš„é…ç½®æ–¹å¼ï¼Œåˆ›å»ºä¸€ä¸ªåº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡ï¼Œæ³¨å†Œ beanï¼Œç„¶åå…³é—­åº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡ã€‚

```java
public class DestroyBeanApplication {

    public static void main(String[] args) {
        // åˆ›å»ºä¸€ä¸ªåŸºäºæ³¨è§£çš„åº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡å¯¹è±¡
        AnnotationConfigApplicationContext context = new AnnotationConfigApplicationContext();
        // æ³¨å†Œé…ç½®ç±» MyBeanï¼Œå‘Šè¯‰ Spring åœ¨å®¹å™¨ä¸­ç®¡ç†è¿™ä¸ªé…ç½®ç±»æ‰€å®šä¹‰çš„ bean
        context.register(MyBean.class);
        // åˆ·æ–°åº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡ï¼Œåˆå§‹åŒ–å¹¶å¯åŠ¨ Spring å®¹å™¨
        context.refresh();
        // å…³é—­åº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡ï¼Œé”€æ¯ Spring å®¹å™¨å¹¶é‡Šæ”¾èµ„æº
        context.close();
    }
}
```

å®ç°äº† Spring æ¡†æ¶ä¸­ `DisposableBean` æ¥å£çš„ç±»ï¼Œé€šè¿‡å®ç°è¿™ä¸ªæ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ bean é”€æ¯æ—¶æ‰§è¡Œä¸€äº›è‡ªå®šä¹‰çš„æ¸…ç†é€»è¾‘ã€‚

```java
public class MyBean implements DisposableBean {

    @Override
    public void destroy() throws Exception {
        System.out.println("MyBeanè¢«é”€æ¯äº†");
    }
}
```

è¿è¡Œç»“æœå‘ç°ï¼Œå½“ Spring å®¹å™¨å…³é—­æ—¶ï¼Œä¼šè§¦å‘ bean çš„é”€æ¯é˜¶æ®µï¼Œè€Œå®ç°äº† `DisposableBean` æ¥å£çš„ bean å°±ä¼šè°ƒç”¨å…¶ `destroy` æ–¹æ³•ã€‚åœ¨æˆ‘ä»¬çš„ `MyBean` ç±»ä¸­ï¼Œ`destroy` æ–¹æ³•ä¸­åªæœ‰ä¸€è¡Œä»£ç ï¼Œå³æ‰“å°ä¸€æ¡æ¶ˆæ¯ï¼Œå› æ­¤æˆ‘ä»¬åœ¨è¿è¡Œæ—¶çœ‹åˆ°çš„è¾“å‡ºå°±æ˜¯ `"MyBeanè¢«é”€æ¯äº†"`ã€‚

```java
MyBeanè¢«é”€æ¯äº†
```

### å…­ã€æ—¶åºå›¾

~~~mermaid
sequenceDiagram
Title: Beançš„é”€æ¯è¿‡ç¨‹æ—¶åºå›¾

par æ³¨å†Œé€‚é…å™¨é˜¶æ®µ
DestroyBeanApplication->>AbstractApplicationContext: refresh()
Note over AbstractApplicationContext: åˆå§‹åŒ–åº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡

AbstractApplicationContext->>AbstractApplicationContext: finishBeanFactoryInitialization(beanFactory)
Note over AbstractApplicationContext: å®Œæˆbeanå·¥å‚çš„åˆå§‹åŒ–

AbstractApplicationContext->>DefaultListableBeanFactory: preInstantiateSingletons()
Note over DefaultListableBeanFactory: é¢„å®ä¾‹åŒ–æ‰€æœ‰å•ä¾‹bean

DefaultListableBeanFactory->>AbstractBeanFactory: getBean(name)
Note over AbstractBeanFactory: ä»beanå·¥å‚è·å–beanå®ä¾‹

AbstractBeanFactory->>AbstractBeanFactory: doGetBean(name, requiredType, args, typeCheckOnly)
Note over AbstractBeanFactory: å®é™…è·å–beançš„æ–¹æ³•

AbstractBeanFactory->>DefaultSingletonBeanRegistry: getSingleton(beanName, singletonFactory)
Note over DefaultSingletonBeanRegistry: ä»å•ä¾‹æ³¨å†Œè¡¨è·å–å•ä¾‹bean

DefaultSingletonBeanRegistry->>AbstractBeanFactory: getObject()
Note over AbstractBeanFactory: è·å–beançš„å®ä¾‹å¯¹è±¡

AbstractBeanFactory->>AbstractAutowireCapableBeanFactory: createBean(beanName, mbd, args)
Note over AbstractAutowireCapableBeanFactory: åˆ›å»ºbeanå®ä¾‹

AbstractAutowireCapableBeanFactory->>AbstractAutowireCapableBeanFactory: doCreateBean(beanName, mbdToUse, args)
Note over AbstractAutowireCapableBeanFactory: å®é™…åˆ›å»ºbeanå®ä¾‹çš„æ–¹æ³•

AbstractAutowireCapableBeanFactory->>AbstractBeanFactory: registerDisposableBeanIfNecessary(beanName, bean, mbd)
Note over AbstractBeanFactory: æ³¨å†Œbeançš„é”€æ¯é€‚é…å™¨

AbstractBeanFactory->>DisposableBeanAdapter: new DisposableBeanAdapter(bean, beanName, beanDefinition, postProcessors, acc)
Note over DisposableBeanAdapter: åˆ›å»ºbeançš„é”€æ¯é€‚é…å™¨

DisposableBeanAdapter->>AbstractBeanFactory: è¿”å›é”€æ¯Beané€‚é…å™¨
Note over AbstractBeanFactory: è¿”å›é”€æ¯Beané€‚é…å™¨

AbstractBeanFactory->>DefaultSingletonBeanRegistry: registerDisposableBean(beanName, bean)
Note over DefaultSingletonBeanRegistry: æ³¨å†Œå•ä¾‹beançš„é”€æ¯é€‚é…å™¨
end

par Beané”€æ¯é˜¶æ®µ
DestroyBeanApplication->>AbstractApplicationContext: close()
Note over AbstractApplicationContext: å…³é—­åº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡

AbstractApplicationContext->>AbstractApplicationContext: doClose()
Note over AbstractApplicationContext: æ‰§è¡Œå…³é—­æ“ä½œ

AbstractApplicationContext->>AbstractApplicationContext: destroyBeans()
Note over AbstractApplicationContext: é”€æ¯æ‰€æœ‰bean

AbstractApplicationContext->>DefaultListableBeanFactory: destroySingletons()
Note over DefaultListableBeanFactory: é”€æ¯æ‰€æœ‰å•ä¾‹bean

DefaultListableBeanFactory->>DefaultSingletonBeanRegistry: destroySingletons()
Note over DefaultSingletonBeanRegistry: é”€æ¯æ‰€æœ‰å•ä¾‹bean

DefaultSingletonBeanRegistry->>DefaultSingletonBeanRegistry: destroySingleton(beanName)
Note over DefaultSingletonBeanRegistry: é”€æ¯å•ä¾‹bean

DefaultSingletonBeanRegistry->>DefaultSingletonBeanRegistry: destroyBean(beanName, disposableBean)
Note over DefaultSingletonBeanRegistry: é”€æ¯beançš„é”€æ¯é€‚é…å™¨

DefaultSingletonBeanRegistry->>DisposableBeanAdapter: destroy()
Note over DisposableBeanAdapter: è°ƒç”¨beançš„destroyæ–¹æ³•

DisposableBeanAdapter->>MyBean: destroy()
Note over MyBean: MyBeançš„é”€æ¯é€»è¾‘æ‰§è¡Œ
end
~~~

### ä¸ƒã€æºç åˆ†æ

#### æ³¨å†Œé€‚é…å™¨

åœ¨`org.springframework.context.support.AbstractApplicationContext#refresh`æ–¹æ³•ä¸­æˆ‘ä»¬é‡ç‚¹å…³æ³¨ä¸€ä¸‹`finishBeanFactoryInitialization(beanFactory)`è¿™æ–¹æ³•ä¼šå¯¹å®ä¾‹åŒ–æ‰€æœ‰å‰©ä½™éæ‡’åŠ è½½çš„å•åˆ—Beanå¯¹è±¡ï¼Œå…¶ä»–æ–¹æ³•ä¸æ˜¯æœ¬æ¬¡æºç é˜…è¯»çš„é‡ç‚¹æš‚æ—¶å¿½ç•¥ã€‚

```java
@Override
public void refresh() throws BeansException, IllegalStateException {
    // ... [ä»£ç éƒ¨åˆ†çœç•¥ä»¥ç®€åŒ–]
    // Instantiate all remaining (non-lazy-init) singletons.
    finishBeanFactoryInitialization(beanFactory);
    // ... [ä»£ç éƒ¨åˆ†çœç•¥ä»¥ç®€åŒ–]
}
```

åœ¨`org.springframework.context.support.AbstractApplicationContext#finishBeanFactoryInitialization`æ–¹æ³•ä¸­ï¼Œä¼šç»§ç»­è°ƒç”¨`DefaultListableBeanFactory`ç±»ä¸­çš„`preInstantiateSingletons`æ–¹æ³•æ¥å®Œæˆæ‰€æœ‰å‰©ä½™éæ‡’åŠ è½½çš„å•åˆ—Beanå¯¹è±¡ã€‚

```java
protected void finishBeanFactoryInitialization(ConfigurableListableBeanFactory beanFactory) {
    // ... [ä»£ç éƒ¨åˆ†çœç•¥ä»¥ç®€åŒ–]
    // å®Œæˆæ‰€æœ‰å‰©ä½™éæ‡’åŠ è½½çš„å•åˆ—Beanå¯¹è±¡ã€‚
    beanFactory.preInstantiateSingletons();
}
```

åœ¨`org.springframework.beans.factory.support.DefaultListableBeanFactory#preInstantiateSingletons`æ–¹æ³•ä¸­ï¼Œä¸»è¦çš„æ ¸å¿ƒç›®çš„æ˜¯é¢„å…ˆå®ä¾‹åŒ–æ‰€æœ‰éæ‡’åŠ è½½çš„å•ä¾‹beanã€‚åœ¨Springçš„ä¸Šä¸‹æ–‡åˆå§‹åŒ–å®Œæˆåï¼Œè¯¥æ–¹æ³•ä¼šè¢«è§¦å‘ï¼Œä»¥ç¡®ä¿æ‰€æœ‰å•ä¾‹beanéƒ½è¢«æ­£ç¡®åœ°åˆ›å»ºå¹¶åˆå§‹åŒ–ã€‚å…¶ä¸­`getBean(beanName)`æ˜¯æ­¤æ–¹æ³•çš„æ ¸å¿ƒæ“ä½œã€‚å¯¹äºå®¹å™¨ä¸­å®šä¹‰çš„æ¯ä¸€ä¸ªå•ä¾‹beanï¼Œéƒ½ä¼šè°ƒç”¨`getBean`æ–¹æ³•ï¼Œè¿™å°†è§¦å‘beançš„å®ä¾‹åŒ–ã€åˆå§‹åŒ–åŠå…¶ä¾èµ–çš„æ³¨å…¥ã€‚å¦‚æœbeanä¹‹å‰æ²¡æœ‰è¢«åˆ›å»ºè¿‡ï¼Œé‚£ä¹ˆè¿™ä¸ªè°ƒç”¨ä¼šå¯¼è‡´å…¶è¢«å®ä¾‹åŒ–å’Œåˆå§‹åŒ–ã€‚

```java
public void preInstantiateSingletons() throws BeansException {
    // ... [ä»£ç éƒ¨åˆ†çœç•¥ä»¥ç®€åŒ–]
    // å¾ªç¯éå†æ‰€æœ‰beançš„åç§°
    for (String beanName : beanNames) {
        getBean(beanName);
    }
    // ... [ä»£ç éƒ¨åˆ†çœç•¥ä»¥ç®€åŒ–]
}
```

åœ¨`org.springframework.beans.factory.support.AbstractBeanFactory#getBean()`æ–¹æ³•ä¸­ï¼Œåˆè°ƒç”¨äº†`doGetBean`æ–¹æ³•æ¥å®é™…æ‰§è¡Œåˆ›å»ºBeançš„è¿‡ç¨‹ï¼Œä¼ é€’ç»™å®ƒbeançš„åç§°å’Œä¸€äº›å…¶ä»–é»˜è®¤çš„å‚æ•°å€¼ã€‚æ­¤å¤„ï¼Œ`doGetBean`è´Ÿè´£å¤§éƒ¨åˆ†å·¥ä½œï¼Œå¦‚æŸ¥æ‰¾beanå®šä¹‰ã€åˆ›å»ºbeanï¼ˆå¦‚æœå°šæœªåˆ›å»ºï¼‰ã€å¤„ç†ä¾èµ–å…³ç³»ç­‰ã€‚

```java
@Override
public Object getBean(String name) throws BeansException {
    return doGetBean(name, null, null, false);
}
```

åœ¨`org.springframework.beans.factory.support.AbstractBeanFactory#doGetBean`æ–¹æ³•ä¸­ï¼Œé¦–å…ˆæ£€æŸ¥æ‰€è¯·æ±‚çš„beanæ˜¯å¦æ˜¯ä¸€ä¸ªå•ä¾‹å¹¶ä¸”å·²ç»åˆ›å»ºã€‚å¦‚æœå°šæœªåˆ›å»ºï¼Œå°†åˆ›å»ºä¸€ä¸ªæ–°çš„å®ä¾‹ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œå¤„ç†å¯èƒ½çš„å¼‚å¸¸æƒ…å†µï¼Œå¦‚å¾ªç¯å¼•ç”¨ï¼Œå¹¶ç¡®ä¿è¿”å›çš„beanæ˜¯æ­£ç¡®çš„ç±»å‹ã€‚è¿™æ˜¯Springå®¹å™¨beanç”Ÿå‘½å‘¨æœŸç®¡ç†çš„æ ¸å¿ƒéƒ¨åˆ†ã€‚

```java
protected <T> T doGetBean(
        String name, @Nullable Class<T> requiredType, @Nullable Object[] args, boolean typeCheckOnly)
        throws BeansException {
    // ... [ä»£ç éƒ¨åˆ†çœç•¥ä»¥ç®€åŒ–]

    // å¼€å§‹åˆ›å»ºbeanå®ä¾‹
    if (mbd.isSingleton()) {
        // å¦‚æœbeanæ˜¯å•ä¾‹çš„ï¼Œæˆ‘ä»¬ä¼šå°è¯•ä»å•ä¾‹ç¼“å­˜ä¸­è·å–
        // å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™ä½¿ç”¨lambdaåˆ›å»ºä¸€ä¸ªæ–°çš„å®ä¾‹
        sharedInstance = getSingleton(beanName, () -> {
            try {
                // å°è¯•åˆ›å»ºbeanå®ä¾‹
                return createBean(beanName, mbd, args);
            }
            catch (BeansException ex) {
                // ... [ä»£ç éƒ¨åˆ†çœç•¥ä»¥ç®€åŒ–]
            }
        });
        // å¯¹äºæŸäº›beanï¼ˆä¾‹å¦‚FactoryBeansï¼‰ï¼Œå¯èƒ½éœ€è¦è¿›ä¸€æ­¥å¤„ç†ä»¥è·å–çœŸæ­£çš„beanå®ä¾‹
        beanInstance = getObjectForBeanInstance(sharedInstance, name, beanName, mbd);
    }
    // ... [ä»£ç éƒ¨åˆ†çœç•¥ä»¥ç®€åŒ–]

    // ç¡®ä¿è¿”å›çš„beanå®ä¾‹ä¸è¯·æ±‚çš„ç±»å‹åŒ¹é…
    return adaptBeanInstance(name, beanInstance, requiredType);
}
```

åœ¨`org.springframework.beans.factory.support.DefaultSingletonBeanRegistry#getSingleton()`æ–¹æ³•ä¸­ï¼Œä¸»è¦è´Ÿè´£ä»å•ä¾‹ç¼“å­˜ä¸­è·å–ä¸€ä¸ªå·²å­˜åœ¨çš„beanå®ä¾‹ï¼Œæˆ–è€…ä½¿ç”¨æä¾›çš„`ObjectFactory`åˆ›å»ºä¸€ä¸ªæ–°çš„å®ä¾‹ã€‚è¿™æ˜¯ç¡®ä¿beanåœ¨Springå®¹å™¨ä¸­ä½œä¸ºå•ä¾‹å­˜åœ¨çš„å…³é”®éƒ¨åˆ†ã€‚

```java
public Object getSingleton(String beanName, ObjectFactory<?> singletonFactory) {
    // æ–­è¨€beanåç§°ä¸èƒ½ä¸ºç©º
    Assert.notNull(beanName, "Bean name must not be null");

    // åŒæ­¥è®¿é—®å•ä¾‹å¯¹è±¡ç¼“å­˜ï¼Œç¡®ä¿çº¿ç¨‹å®‰å…¨
    synchronized (this.singletonObjects) {
        // ä»ç¼“å­˜ä¸­è·å–å•ä¾‹å¯¹è±¡
        Object singletonObject = this.singletonObjects.get(beanName);

        // å¦‚æœç¼“å­˜ä¸­æ²¡æœ‰æ‰¾åˆ°
        if (singletonObject == null) {
            // ... [ä»£ç éƒ¨åˆ†çœç•¥ä»¥ç®€åŒ–]

            try {
                // ä½¿ç”¨å·¥å‚åˆ›å»ºæ–°çš„å•ä¾‹å®ä¾‹
                singletonObject = singletonFactory.getObject();
                newSingleton = true;
            }
            catch (IllegalStateException ex) {
                // ... [ä»£ç éƒ¨åˆ†çœç•¥ä»¥ç®€åŒ–]
            }
            catch (BeanCreationException ex) {
                // ... [ä»£ç éƒ¨åˆ†çœç•¥ä»¥ç®€åŒ–]
            }
            finally {
                // ... [ä»£ç éƒ¨åˆ†çœç•¥ä»¥ç®€åŒ–]
            }

            // ... [ä»£ç éƒ¨åˆ†çœç•¥ä»¥ç®€åŒ–]
        }

        // è¿”å›å•ä¾‹å¯¹è±¡
        return singletonObject;
    }
}
```

åœ¨`org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#createBean()`æ–¹æ³•ä¸­ï¼Œä¸»è¦çš„é€»è¾‘æ˜¯è°ƒç”¨ `doCreateBean`ï¼Œè¿™æ˜¯çœŸæ­£è¿›è¡Œ bean å®ä¾‹åŒ–ã€å±æ€§å¡«å……å’Œåˆå§‹åŒ–çš„åœ°æ–¹ã€‚è¿™ä¸ªæ–¹æ³•ä¼šè¿”å›æ–°åˆ›å»ºçš„ bean å®ä¾‹ã€‚

```java
@Override
protected Object createBean(String beanName, RootBeanDefinition mbd, @Nullable Object[] args)
    throws BeanCreationException {
    
    // ... [ä»£ç éƒ¨åˆ†çœç•¥ä»¥ç®€åŒ–]
    
    try {
        // æ­£å¸¸çš„beanå®ä¾‹åŒ–ã€å±æ€§æ³¨å…¥å’Œåˆå§‹åŒ–ã€‚
        // è¿™é‡Œæ˜¯çœŸæ­£è¿›è¡Œbeanåˆ›å»ºçš„éƒ¨åˆ†ã€‚
        Object beanInstance = doCreateBean(beanName, mbdToUse, args);
        // è®°å½•beanæˆåŠŸåˆ›å»ºçš„æ—¥å¿—
        if (logger.isTraceEnabled()) {
            logger.trace("Finished creating instance of bean '" + beanName + "'");
        }
        return beanInstance;
    }
    catch (BeanCreationException | ImplicitlyAppearedSingletonException ex) {
        // ... [ä»£ç éƒ¨åˆ†çœç•¥ä»¥ç®€åŒ–]
    }
    catch (Throwable ex) {
        // ... [ä»£ç éƒ¨åˆ†çœç•¥ä»¥ç®€åŒ–]
    }
}
```

åœ¨`org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#doCreateBean`æ–¹æ³•ä¸­ï¼Œä¸»è¦æ˜¯åœ¨åˆ›å»º bean å®ä¾‹çš„è¿‡ç¨‹ä¸­æ³¨å†Œäº†é”€æ¯é€‚é…å™¨ï¼Œä»¥ä¾¿åœ¨å®¹å™¨å…³é—­æ—¶èƒ½å¤Ÿæ‰§è¡Œç›¸åº”çš„é”€æ¯é€»è¾‘ã€‚

```java
protected Object doCreateBean(String beanName, RootBeanDefinition mbd, @Nullable Object[] args)
        throws BeanCreationException {

    // åœ¨æ­¤æ³¨å†Œbeanä»¥ä¾¿åœ¨é”€æ¯æ—¶è¿›è¡Œå¤„ç†ã€‚
    try {
        registerDisposableBeanIfNecessary(beanName, bean, mbd);
    }
    catch (BeanDefinitionValidationException ex) {
        // ... [ä»£ç éƒ¨åˆ†çœç•¥ä»¥ç®€åŒ–]
    }
}
```

åœ¨`org.springframework.beans.factory.support.AbstractBeanFactory#registerDisposableBeanIfNecessary`æ–¹æ³•ä¸­ï¼Œé¦–å…ˆæ£€æŸ¥Beançš„ä½œç”¨åŸŸæ˜¯å¦ä¸ºå•ä¾‹ä¸”æ˜¯å¦éœ€è¦æ‰§è¡Œé”€æ¯é€»è¾‘ã€‚å¦‚æœæ˜¯å•ä¾‹ä½œç”¨åŸŸï¼Œæ³¨å†Œä¸€ä¸ª`DisposableBean`é€‚é…å™¨ï¼Œè´Ÿè´£æ‰§è¡Œå„ç§é”€æ¯å·¥ä½œï¼ŒåŒ…æ‹¬`DestructionAwareBeanPostProcessors`ã€`DisposableBean`æ¥å£ä»¥åŠè‡ªå®šä¹‰çš„é”€æ¯æ–¹æ³•ã€‚å¯¹äºè‡ªå®šä¹‰ä½œç”¨åŸŸï¼ŒæŸ¥æ‰¾ç›¸åº”çš„Scopeå¹¶æ³¨å†Œé”€æ¯å›è°ƒã€‚

```java
protected void registerDisposableBeanIfNecessary(String beanName, Object bean, RootBeanDefinition mbd) {
    // ... [ä»£ç éƒ¨åˆ†çœç•¥ä»¥ç®€åŒ–]

    // æ£€æŸ¥æ˜¯å¦ä¸ºåŸå‹ä½œç”¨åŸŸï¼ˆprototypeï¼‰ï¼Œä»¥åŠæ˜¯å¦éœ€è¦é”€æ¯
    if (!mbd.isPrototype() && requiresDestruction(bean, mbd)) {
        if (mbd.isSingleton()) {
            // å¦‚æœæ˜¯å•ä¾‹ä½œç”¨åŸŸï¼Œæ³¨å†Œä¸€ä¸ª DisposableBean é€‚é…å™¨ï¼Œè¯¥é€‚é…å™¨æ‰§è¡Œæ‰€æœ‰é”€æ¯å·¥ä½œ
            // åŒ…æ‹¬ DestructionAwareBeanPostProcessorsã€DisposableBean æ¥å£ã€è‡ªå®šä¹‰é”€æ¯æ–¹æ³•ç­‰
            registerDisposableBean(beanName, new DisposableBeanAdapter(
                bean, beanName, mbd, getBeanPostProcessorCache().destructionAware, acc));
        } else {
            // å¦‚æœæ˜¯è‡ªå®šä¹‰ä½œç”¨åŸŸï¼Œæ‰¾åˆ°ç›¸åº”çš„ Scope å¹¶æ³¨å†Œé”€æ¯å›è°ƒ
            Scope scope = this.scopes.get(mbd.getScope());
            if (scope == null) {
                throw new IllegalStateException("No Scope registered for scope name '" + mbd.getScope() + "'");
            }
            // æ³¨å†Œä¸€ä¸ª DisposableBean é€‚é…å™¨ï¼Œè¯¥é€‚é…å™¨æ‰§è¡Œæ‰€æœ‰é”€æ¯å·¥ä½œ
            scope.registerDestructionCallback(beanName, new DisposableBeanAdapter(
                bean, beanName, mbd, getBeanPostProcessorCache().destructionAware, acc));
        }
    }
}
```

åœ¨`org.springframework.beans.factory.support.AbstractBeanFactory#requiresDestruction`æ–¹æ³•ä¸­ï¼Œå¦‚æœ bean ç±»å‹ä¸æ˜¯ `NullBean` ä¸”å­˜åœ¨é”€æ¯æ–¹æ³•æˆ–ä¸é”€æ¯ç›¸å…³çš„ `DestructionAwareBeanPostProcessor`ï¼Œåˆ™è¿”å› `true`ï¼Œè¡¨ç¤ºè¯¥ bean éœ€è¦æ‰§è¡Œé”€æ¯é€»è¾‘ã€‚å¦åˆ™ï¼Œè¿”å› `false`ï¼Œè¡¨ç¤ºä¸éœ€è¦æ‰§è¡Œé”€æ¯é€»è¾‘ã€‚

```java
protected boolean requiresDestruction(Object bean, RootBeanDefinition mbd) {
   return (bean.getClass() != NullBean.class && (DisposableBeanAdapter.hasDestroyMethod(bean, mbd) ||
         (hasDestructionAwareBeanPostProcessors() && DisposableBeanAdapter.hasApplicableProcessors(
               bean, getBeanPostProcessorCache().destructionAware))));
}
```

åœ¨`org.springframework.beans.factory.support.DisposableBeanAdapter#DisposableBeanAdapter`æ–¹æ³•ä¸­ï¼Œä¸»è¦ç”¨äºå¤„ç† Bean é”€æ¯é€»è¾‘çš„é€‚é…å™¨ã€‚æ ¹æ® Bean çš„å®šä¹‰å’Œç±»å‹ä¿¡æ¯ï¼Œç¡®å®šæ˜¯å¦å­˜åœ¨å¯è°ƒç”¨çš„é”€æ¯æ–¹æ³•ï¼Œä»¥åŠå¦‚ä½•æ‰§è¡Œé”€æ¯é€»è¾‘ã€‚åœ¨åˆå§‹åŒ–è¿‡ç¨‹ä¸­ï¼Œæ£€æŸ¥æ˜¯å¦å®ç°äº† `DisposableBean` æ¥å£ã€å­˜åœ¨è‡ªå®šä¹‰çš„é”€æ¯æ–¹æ³•ï¼Œä»¥åŠç›¸å…³çš„ BeanPostProcessorã€‚å¦‚æœå­˜åœ¨å¯è°ƒç”¨çš„é”€æ¯æ–¹æ³•ï¼Œå°†è¿›è¡Œç›¸å…³çš„é…ç½®ï¼Œä»¥ä¾¿åœ¨å®¹å™¨å…³é—­æ—¶æ‰§è¡Œé”€æ¯é€»è¾‘ã€‚

```java
public DisposableBeanAdapter(Object bean, String beanName, RootBeanDefinition beanDefinition,
        List<DestructionAwareBeanPostProcessor> postProcessors, @Nullable AccessControlContext acc) {

    // ç¡®ä¿å¾…é”€æ¯çš„ Bean å®ä¾‹ä¸ä¸º null
    Assert.notNull(bean, "Disposable bean must not be null");

    // åˆå§‹åŒ–å®ä¾‹å˜é‡
    this.bean = bean;
    this.beanName = beanName;

    // ç¡®å®šæ˜¯å¦éœ€è¦è°ƒç”¨ DisposableBean æ¥å£çš„ destroy æ–¹æ³•
    this.invokeDisposableBean = (this.bean instanceof DisposableBean && !beanDefinition.isExternallyManagedDestroyMethod("destroy"));

    // æ˜¯å¦å…è®¸è®¿é—®éå…¬å…±æ–¹æ³•
    this.nonPublicAccessAllowed = beanDefinition.isNonPublicAccessAllowed();
    this.acc = acc;

    // æ¨æ–­é”€æ¯æ–¹æ³•çš„åç§°
    String destroyMethodName = inferDestroyMethodIfNecessary(bean, beanDefinition);

    // å¦‚æœå­˜åœ¨é”€æ¯æ–¹æ³•ï¼Œå¹¶ä¸”ä¸æ˜¯å¤–éƒ¨ç®¡ç†çš„ destroy æ–¹æ³•ï¼Œåˆ™è¿›è¡Œç›¸å…³å¤„ç†
    if (destroyMethodName != null && !(this.invokeDisposableBean && "destroy".equals(destroyMethodName)) &&
        !beanDefinition.isExternallyManagedDestroyMethod(destroyMethodName)) {
        
        // è®°å½•é”€æ¯æ–¹æ³•çš„åç§°
        this.destroyMethodName = destroyMethodName;

        // ç¡®å®šé”€æ¯æ–¹æ³•
        Method destroyMethod = determineDestroyMethod(destroyMethodName);

        // å¦‚æœæ‰¾ä¸åˆ°é”€æ¯æ–¹æ³•ï¼Œå¹¶ä¸” Bean å®šä¹‰è¦æ±‚å¼ºåˆ¶å­˜åœ¨ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸
        if (destroyMethod == null) {
            // ... [ä»£ç éƒ¨åˆ†çœç•¥ä»¥ç®€åŒ–]
        }
        // å¦åˆ™ï¼Œæ£€æŸ¥é”€æ¯æ–¹æ³•çš„åˆæ³•æ€§
        else {
            if (destroyMethod.getParameterCount() > 0) {
                Class<?>[] paramTypes = destroyMethod.getParameterTypes();
                // ... [ä»£ç éƒ¨åˆ†çœç•¥ä»¥ç®€åŒ–]
            }
            // è·å–é”€æ¯æ–¹æ³•çš„æ¥å£æ–¹æ³•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            destroyMethod = ClassUtils.getInterfaceMethodIfPossible(destroyMethod);
        }
        // è®°å½•é”€æ¯æ–¹æ³•
        this.destroyMethod = destroyMethod;
    }

    // è¿‡æ»¤ä¸é”€æ¯ç›¸å…³çš„ BeanPostProcessor
    this.beanPostProcessors = filterPostProcessors(postProcessors, bean);
}
```

åœ¨`org.springframework.beans.factory.support.DefaultSingletonBeanRegistry#registerDisposableBean`æ–¹æ³•ä¸­ï¼Œ

```java
public void registerDisposableBean(String beanName, DisposableBean bean) {
    // ä½¿ç”¨åŒæ­¥å—ç¡®ä¿çº¿ç¨‹å®‰å…¨
    synchronized (this.disposableBeans) {
        // å°†å¾…é”€æ¯çš„ Bean æ”¾å…¥ disposableBeans é›†åˆä¸­
        this.disposableBeans.put(beanName, bean);
    }
}
```

#### Beané”€æ¯

åœ¨`org.springframework.context.support.AbstractApplicationContext#close`æ–¹æ³•ä¸­ï¼Œé¦–å…ˆæ˜¯å¯åŠ¨äº†ä¸€ä¸ªåŒæ­¥å—ï¼Œå®ƒåŒæ­¥åœ¨ `startupShutdownMonitor` å¯¹è±¡ä¸Šã€‚è¿™ç¡®ä¿äº†åœ¨ç»™å®šæ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥æ‰§è¡Œè¿™ä¸ªå—å†…çš„ä»£ç ï¼Œé˜²æ­¢å¤šçº¿ç¨‹å¯¼è‡´çš„èµ„æºç«äº‰æˆ–æ•°æ®ä¸ä¸€è‡´ï¼Œç„¶åæ˜¯è°ƒç”¨äº† `doClose` æ–¹æ³•ã€‚

```java
@Override
public void close() {
    synchronized (this.startupShutdownMonitor) {
        doClose();
        // ... [ä»£ç éƒ¨åˆ†çœç•¥ä»¥ç®€åŒ–]
    }
}
```

åœ¨`org.springframework.context.support.AbstractApplicationContext#doClose`æ–¹æ³•ä¸­ï¼Œåˆè°ƒç”¨äº† `destroyBeans` æ–¹æ³•ã€‚

```java
protected void doClose() {
    // ... [ä»£ç éƒ¨åˆ†çœç•¥ä»¥ç®€åŒ–]
    // Destroy all cached singletons in the context's BeanFactory.
    destroyBeans();
    // ... [ä»£ç éƒ¨åˆ†çœç•¥ä»¥ç®€åŒ–]
}
```

åœ¨`org.springframework.context.support.AbstractApplicationContext#destroyBeans`æ–¹æ³•ä¸­ï¼Œé¦–å…ˆæ˜¯è°ƒç”¨äº†`getBeanFactory()`è¿”å› Spring çš„ `BeanFactory` ï¼Œç„¶ååœ¨è·å¾—çš„ `BeanFactory` ä¸Šï¼Œè°ƒç”¨äº† `destroySingletons` æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•çš„ç›®çš„æ˜¯é”€æ¯æ‰€æœ‰åœ¨ `BeanFactory` ä¸­ç¼“å­˜çš„å•ä¾‹ beansã€‚

```java
protected void destroyBeans() {
    getBeanFactory().destroySingletons();
}
```

åœ¨`org.springframework.beans.factory.support.DefaultListableBeanFactory#destroySingletons`æ–¹æ³•ä¸­ï¼Œé¦–å…ˆæ˜¯è°ƒç”¨äº†çˆ¶ç±»çš„ `destroySingletons` æ–¹æ³•ï¼Œä¸ºäº†ç¡®ä¿ç»§æ‰¿è‡ªçˆ¶ç±»çš„é”€æ¯é€»è¾‘å¾—åˆ°äº†æ‰§è¡Œã€‚

```java
@Override
public void destroySingletons() {
    super.destroySingletons();
    // ... [ä»£ç éƒ¨åˆ†çœç•¥ä»¥ç®€åŒ–]
}
```

åœ¨`org.springframework.beans.factory.support.DefaultSingletonBeanRegistry#destroySingletons`æ–¹æ³•ä¸­ï¼Œé¦–å…ˆæ˜¯åœ¨`disposableBeans` å­—æ®µä¸Šï¼Œä»å…¶é”®é›†åˆä¸­è·å–æ‰€æœ‰çš„ bean åç§°ï¼Œå¹¶å°†å®ƒä»¬è½¬æ¢ä¸ºä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„ã€‚`disposableBeans` å¯èƒ½åŒ…å«äº†å®ç°äº† `DisposableBean` æ¥å£çš„ beansï¼Œè¿™äº› beans éœ€è¦åœ¨å®¹å™¨é”€æ¯æ—¶ç‰¹æ®Šå¤„ç†ï¼Œæœ€åå€’åºå¾ªç¯ï¼Œä»æœ€åä¸€ä¸ªå¼€å§‹ï¼Œé”€æ¯æ‰€æœ‰åœ¨ `disposableBeans` åˆ—è¡¨ä¸­çš„ beansã€‚è¿™æ ·åšæ˜¯ä¸ºäº†ç¡®ä¿ä¾èµ–å…³ç³»æ­£ç¡®åœ°å¤„ç†ï¼Œbeanså…ˆè¢«åˆ›å»ºçš„åº”è¯¥åè¢«é”€æ¯ã€‚

```java
public void destroySingletons() {
    // ... [ä»£ç éƒ¨åˆ†çœç•¥ä»¥ç®€åŒ–]
    String[] disposableBeanNames;
    synchronized (this.disposableBeans) {
        disposableBeanNames = StringUtils.toStringArray(this.disposableBeans.keySet());
    }
    for (int i = disposableBeanNames.length - 1; i >= 0; i--) {
        destroySingleton(disposableBeanNames[i]);
    }
    // ... [ä»£ç éƒ¨åˆ†çœç•¥ä»¥ç®€åŒ–]
}
```

åœ¨`org.springframework.beans.factory.support.DefaultListableBeanFactory#destroySingleton`æ–¹æ³•ä¸­ï¼Œé¦–å…ˆæ˜¯è°ƒç”¨äº†çˆ¶ç±»çš„ `destroySingleton` æ–¹æ³•ï¼Œä¸ºäº†ç¡®ä¿ç»§æ‰¿è‡ªçˆ¶ç±»çš„é”€æ¯é€»è¾‘å¾—åˆ°äº†æ‰§è¡Œã€‚

```java
@Override
public void destroySingleton(String beanName) {
    super.destroySingleton(beanName);
    // ... [ä»£ç éƒ¨åˆ†çœç•¥ä»¥ç®€åŒ–]
}
```

åœ¨`org.springframework.beans.factory.support.DefaultSingletonBeanRegistry#destroySingleton`æ–¹æ³•ä¸­ï¼Œé¦–å…ˆæ˜¯ä½¿ç”¨ `synchronized` å…³é”®å­—åœ¨ `disposableBeans` å¯¹è±¡ä¸Šè¿›è¡ŒåŒæ­¥ï¼Œä»¥ç¡®ä¿åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­å®‰å…¨åœ°è®¿é—®å’Œä¿®æ”¹å®ƒï¼Œä» `disposableBeans` é›†åˆä¸­ç§»é™¤æŒ‡å®šåç§°çš„ beanï¼Œå¹¶å°†å…¶è½¬æ¢ä¸º `DisposableBean` ç±»å‹ï¼Œæœ€åè°ƒç”¨`destroyBean`æ–¹æ³•æ‰§è¡Œå®é™…çš„é”€æ¯æ“ä½œã€‚

```java
public void destroySingleton(String beanName) {
    // ä»å·²æ³¨å†Œçš„å•ä¾‹ä¸­ç§»é™¤æŒ‡å®šåç§°çš„å•ä¾‹ Bean
    removeSingleton(beanName);

    // è·å–å¯¹åº”çš„ DisposableBean å®ä¾‹
    DisposableBean disposableBean;
    synchronized (this.disposableBeans) {
        disposableBean = (DisposableBean) this.disposableBeans.remove(beanName);
    }

    // æ‰§è¡Œé”€æ¯é€»è¾‘
    destroyBean(beanName, disposableBean);
}
```

åœ¨`org.springframework.beans.factory.support.DefaultSingletonBeanRegistry#destroyBean`æ–¹æ³•ä¸­ï¼Œä¸»è¦ç”¨äºé”€æ¯ç»™å®šåç§°çš„ Beanï¼ŒåŒ…æ‹¬è§¦å‘å…¶ä¾èµ–å…³ç³»çš„é”€æ¯ã€æ‰§è¡Œ Bean çš„ `destroy` æ–¹æ³•ä»¥åŠé”€æ¯è¯¥ Bean åŒ…å«çš„å…¶ä»– Beanï¼Œæœ€åï¼Œæ¸…ç†å·²é”€æ¯ Bean çš„ä¾èµ–å…³ç³»å’Œå‡†å¤‡å¥½çš„ä¾èµ–ä¿¡æ¯ã€‚

```java
protected void destroyBean(String beanName, @Nullable DisposableBean bean) {
    // è§¦å‘é”€æ¯ä¾èµ–äºè¯¥ Bean çš„å…¶ä»– Bean...
    Set<String> dependencies;
    
    // åœ¨å®Œå…¨åŒæ­¥çš„æƒ…å†µä¸‹ï¼Œä»¥ç¡®ä¿è·å–çš„ Set æ˜¯çº¿ç¨‹å®‰å…¨çš„
    synchronized (this.dependentBeanMap) {
        dependencies = this.dependentBeanMap.remove(beanName);
    }
    
    if (dependencies != null) {
        // ... [ä»£ç éƒ¨åˆ†çœç•¥ä»¥ç®€åŒ–]
        for (String dependentBeanName : dependencies) {
            destroySingleton(dependentBeanName);
        }
    }

    // å®é™…æ‰§è¡Œ Bean çš„é”€æ¯é€»è¾‘...
    if (bean != null) {
        try {
            bean.destroy();
        }
        catch (Throwable ex) {
            // ... [ä»£ç éƒ¨åˆ†çœç•¥ä»¥ç®€åŒ–]
        }
    }

    // è§¦å‘é”€æ¯è¯¥ Bean åŒ…å«çš„å…¶ä»– Bean...
    Set<String> containedBeans;
    synchronized (this.containedBeanMap) {
        // åœ¨å®Œå…¨åŒæ­¥çš„æƒ…å†µä¸‹ï¼Œä»¥ç¡®ä¿è·å–çš„ Set æ˜¯æ–­å¼€è¿æ¥çš„
        containedBeans = this.containedBeanMap.remove(beanName);
    }
    if (containedBeans != null) {
        for (String containedBeanName : containedBeans) {
            destroySingleton(containedBeanName);
        }
    }

    // ä»å…¶ä»– Bean çš„ä¾èµ–å…³ç³»ä¸­ç§»é™¤å·²é”€æ¯çš„ Bean...
    synchronized (this.dependentBeanMap) {
        for (Iterator<Map.Entry<String, Set<String>>> it = this.dependentBeanMap.entrySet().iterator(); it.hasNext();) {
            Map.Entry<String, Set<String>> entry = it.next();
            Set<String> dependenciesToClean = entry.getValue();
            dependenciesToClean.remove(beanName);
            if (dependenciesToClean.isEmpty()) {
                it.remove();
            }
        }
    }

    // ç§»é™¤å·²é”€æ¯ Bean çš„å‡†å¤‡å¥½çš„ä¾èµ–ä¿¡æ¯
    this.dependenciesForBeanMap.remove(beanName);
}
```

åœ¨`org.springframework.beans.factory.support.DisposableBeanAdapter#destroy`æ–¹æ³•ä¸­ï¼Œå®ç°äº† `DisposableBean` æ¥å£çš„é”€æ¯æ–¹æ³•ï¼Œè´Ÿè´£åœ¨ Bean é”€æ¯é˜¶æ®µæ‰§è¡Œå„ä¸ªé”€æ¯ç›¸å…³çš„æ“ä½œã€‚è¿™åŒ…æ‹¬å‰ç½®é”€æ¯å¤„ç†ã€è°ƒç”¨ `DisposableBean` æ¥å£çš„ `destroy` æ–¹æ³•ã€æ‰§è¡Œè‡ªå®šä¹‰çš„é”€æ¯æ–¹æ³•ã€‚

```java
@Override
public void destroy() {
    // æ‰§è¡Œ DestructionAwareBeanPostProcessor çš„å‰ç½®é”€æ¯å¤„ç†
    if (!CollectionUtils.isEmpty(this.beanPostProcessors)) {
        for (DestructionAwareBeanPostProcessor processor : this.beanPostProcessors) {
            processor.postProcessBeforeDestruction(this.bean, this.beanName);
        }
    }

    // å¦‚æœå®ç°äº† DisposableBean æ¥å£ï¼Œåˆ™è°ƒç”¨å…¶ destroy æ–¹æ³•
    if (this.invokeDisposableBean) {
        // ... [ä»£ç éƒ¨åˆ†çœç•¥ä»¥ç®€åŒ–]
        try {
            // ... [ä»£ç éƒ¨åˆ†çœç•¥ä»¥ç®€åŒ–]
            ((DisposableBean) this.bean).destroy();
        }
        catch (Throwable ex) {
            // ... [ä»£ç éƒ¨åˆ†çœç•¥ä»¥ç®€åŒ–]
        }
    }

    // å¦‚æœå­˜åœ¨è‡ªå®šä¹‰çš„é”€æ¯æ–¹æ³•ï¼Œåˆ™æ‰§è¡Œ
    if (this.destroyMethod != null) {
        invokeCustomDestroyMethod(this.destroyMethod);
    }
    // å¦‚æœå­˜åœ¨æŒ‡å®šåç§°çš„è‡ªå®šä¹‰é”€æ¯æ–¹æ³•ï¼Œåˆ™æŸ¥æ‰¾å¹¶æ‰§è¡Œ
    else if (this.destroyMethodName != null) {
        Method methodToInvoke = determineDestroyMethod(this.destroyMethodName);
        if (methodToInvoke != null) {
            // è·å–æ¥å£æ–¹æ³•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰å¹¶æ‰§è¡Œè‡ªå®šä¹‰é”€æ¯æ–¹æ³•
            invokeCustomDestroyMethod(ClassUtils.getInterfaceMethodIfPossible(methodToInvoke));
        }
    }
}
```

### å…«ã€æ³¨æ„äº‹é¡¹

1. **é”€æ¯æ–¹æ³•é¿å…æŠ›å‡ºå¼‚å¸¸**

   + åœ¨é”€æ¯æ–¹æ³•ä¸­åº”å°½é‡é¿å…æŠ›å‡ºå¼‚å¸¸ï¼Œå› ä¸ºæŠ›å‡ºçš„å¼‚å¸¸å¯èƒ½ä¼šå½±å“åˆ°å…¶ä»–Beançš„é”€æ¯è¿‡ç¨‹ã€‚å¦‚æœæœ‰å¼‚å¸¸ï¼Œæœ€å¥½è¿›è¡Œé€‚å½“çš„è®°å½•ã€‚

2. **æ³¨æ„Beançš„ä¾èµ–å…³ç³»**

   + ç¡®ä¿é”€æ¯Beançš„é¡ºåºç¬¦åˆä¾èµ–å…³ç³»ï¼Œé¦–å…ˆé”€æ¯ä¾èµ–å…³ç³»è¾ƒå°‘çš„Beanï¼Œç„¶åå†é”€æ¯ä¾èµ–å…³ç³»è¾ƒå¤šçš„Beanã€‚Springå®¹å™¨ä¼šå°½é‡æŒ‰ç…§ä¾èµ–å…³ç³»çš„é¡ºåºé”€æ¯Beanã€‚

3. **æ³¨æ„Beançš„ç”Ÿå‘½å‘¨æœŸå’Œä½œç”¨åŸŸ**

   + å¯¹äºå•ä¾‹ï¼ˆSingletonï¼‰Beanï¼Œå…¶é”€æ¯è¿‡ç¨‹ä¼šåœ¨å®¹å™¨å…³é—­æ—¶è§¦å‘ã€‚å¯¹äºåŸå‹ï¼ˆPrototypeï¼‰Beanï¼ŒSpringå®¹å™¨ä¸ä¼šè´Ÿè´£é”€æ¯ï¼Œéœ€è¦æ‰‹åŠ¨ç®¡ç†ã€‚


### ä¹ã€æ€»ç»“

#### æœ€ä½³å®è·µæ€»ç»“

1. **åˆ›å»ºåº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡**

   + ä½¿ç”¨`AnnotationConfigApplicationContext`åˆ›å»ºä¸€ä¸ªåŸºäºæ³¨è§£çš„åº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡å¯¹è±¡ã€‚

2. **æ³¨å†ŒBean**

   + ä½¿ç”¨`context.register(MyBean.class)`æ³¨å†Œäº†`MyBean`ç±»ï¼Œå‘Šè¯‰Springå®¹å™¨è¦ç®¡ç†è¿™ä¸ªé…ç½®ç±»æ‰€å®šä¹‰çš„beanã€‚

3. **åˆ·æ–°åº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡**

   + ä½¿ç”¨`context.refresh()`åˆ·æ–°åº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡ï¼Œåˆå§‹åŒ–å¹¶å¯åŠ¨Springå®¹å™¨ã€‚

4. **å®¹å™¨å…³é—­**

   + ä½¿ç”¨`context.close()`å…³é—­åº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡ã€‚åœ¨å…³é—­è¿‡ç¨‹ä¸­ï¼ŒSpringå®¹å™¨ä¼šè§¦å‘beançš„é”€æ¯é˜¶æ®µã€‚

5. **Beané”€æ¯**

   + ç”±äº`MyBean`å®ç°äº†`DisposableBean`æ¥å£ï¼Œå› æ­¤åœ¨å®¹å™¨å…³é—­æ—¶ï¼Œä¼šè°ƒç”¨`MyBean`çš„`destroy`æ–¹æ³•ã€‚åœ¨`destroy`æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬ç®€å•åœ°æ‰“å°ä¸€æ¡æ¶ˆæ¯ï¼Œè¡¨ç¤º`MyBean`è¢«é”€æ¯äº†ã€‚
   + æœ€åï¼Œæ§åˆ¶å°è¾“å‡ºäº†`MyBeanè¢«é”€æ¯äº†`çš„æ¶ˆæ¯ï¼Œè¯æ˜äº†beançš„é”€æ¯è¿‡ç¨‹å·²ç»æ‰§è¡Œã€‚

#### æºç åˆ†ææ€»ç»“

1. **æ³¨å†ŒBeané”€æ¯é€‚é…å™¨** 

   + åœ¨`AbstractApplicationContext`çš„`finishBeanFactoryInitialization`æ–¹æ³•ä¸­ï¼Œè°ƒç”¨äº†`DefaultListableBeanFactory`çš„`preInstantiateSingletons`æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šé¢„å…ˆå®ä¾‹åŒ–æ‰€æœ‰éæ‡’åŠ è½½çš„å•ä¾‹beanã€‚åœ¨å®ä¾‹åŒ–çš„è¿‡ç¨‹ä¸­ï¼Œå¯¹äºæ¯ä¸ªbeanï¼Œä¼šè°ƒç”¨`registerDisposableBeanIfNecessary`æ–¹æ³•æ³¨å†Œé”€æ¯é€‚é…å™¨ï¼Œä»¥ç¡®ä¿åœ¨å®¹å™¨å…³é—­æ—¶èƒ½å¤Ÿæ‰§è¡Œç›¸åº”çš„é”€æ¯é€»è¾‘ã€‚

2. **Beané”€æ¯** 

   + åœ¨å®¹å™¨å…³é—­æ—¶ï¼Œé€šè¿‡`AbstractApplicationContext`çš„`close`æ–¹æ³•è§¦å‘é”€æ¯è¿‡ç¨‹ã€‚åœ¨`destroyBeans`æ–¹æ³•ä¸­ï¼Œè°ƒç”¨äº†`DefaultListableBeanFactory`çš„`destroySingletons`æ–¹æ³•ï¼Œè¯¥æ–¹æ³•é”€æ¯æ‰€æœ‰åœ¨`BeanFactory`ä¸­ç¼“å­˜çš„å•ä¾‹beansã€‚

   + åœ¨`destroySingletons`æ–¹æ³•ä¸­ï¼Œéå†`disposableBeans`é›†åˆï¼Œè·å–æ‰€æœ‰å¾…é”€æ¯çš„beanåç§°ï¼Œå¹¶å€’åºå¾ªç¯é”€æ¯è¿™äº›beanã€‚åœ¨é”€æ¯è¿‡ç¨‹ä¸­ï¼Œé¦–å…ˆè°ƒç”¨`destroyBean`æ–¹æ³•æ‰§è¡Œå®é™…çš„é”€æ¯æ“ä½œã€‚

   + åœ¨`destroyBean`æ–¹æ³•ä¸­ï¼Œè§¦å‘é”€æ¯ä¾èµ–äºè¯¥beançš„å…¶ä»–beanï¼Œæ‰§è¡Œbeançš„`destroy`æ–¹æ³•ï¼Œé”€æ¯beanåŒ…å«çš„å…¶ä»–beanï¼Œä»å…¶ä»–beançš„ä¾èµ–å…³ç³»ä¸­ç§»é™¤å·²é”€æ¯çš„beanï¼Œæ¸…ç†å·²é”€æ¯beançš„å‡†å¤‡å¥½çš„ä¾èµ–ä¿¡æ¯ã€‚

   + æœ€åé€šè¿‡`DisposableBeanAdapter`ç±»å¤„ç†Beançš„é”€æ¯é€»è¾‘ã€‚è¯¥ç±»å®ç°äº†`DisposableBean`æ¥å£çš„`destroy`æ–¹æ³•ï¼Œæ‰§è¡Œå‰ç½®é”€æ¯å¤„ç†ã€è°ƒç”¨`DisposableBean`æ¥å£çš„`destroy`æ–¹æ³•ã€æ‰§è¡Œè‡ªå®šä¹‰çš„é”€æ¯æ–¹æ³•ç­‰æ“ä½œã€‚

